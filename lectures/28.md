Sockets
=======

---

Sockets provide a standard interface from the network to our applications

Socket types
------------

- Stream - provides a virtual circuit
- Datagram - delivers individual packets

Socket Implementation
---------------------

- Independent of network type
- Most typically used with TCP/IP and UDP/IP

---

![Socket States](media/socket-states.png)

UDP Sockets in Python
---------------------

Create a socket
---------------

```python
sock = socket.socket(family=AF_INET, type=SOCK_DGRAM)
```

Send Data
---------

- Send raw bytes to a port on a particular IP

```python
sock.sendto(b"Hello!", ("127.0.0.1", 2001))
```

Get Data
--------

- Returns bytes from socket when available

```python
data, address = sock.recvfrom(1024)
```

---

Close a socket

```python
sock.close()
```

Bind
----

- Used when implementing a server
- Tells the OS to direct incoming UDP packets to your process

```python
sock.bind(("127.0.0.1", 2001))
```

Math Server Example
-------------------

```python
import socket

sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

sock.bind(("127.0.0.1", 9999))

while True:
    data, address = sock.recvfrom(1024)
    value = int.from_bytes(data, byteorder="little")
    print(address, value, data)

    square = value ** 2

    sock.sendto(square.to_bytes(4, byteorder="little"), address)
```

QUIC
====

Saving Round Trips
------------------

- The layered nature of our stack can cause inefficiency
- TCP requires a handshake to establish a connection
- If we desire encryption, we need a second handshake to establish that

QUIC
----

- Combines establishing a connection and establishing encryption into one handshake
- Can save one RTT of latency when creating connections
- HTTP/3 uses QUIC for transport

---

![TLS vs QUIC handshake](media/quic-handshake.png)

---

Connection Identifiers in QUIC
------------------------------

- TCP connections are defined by their address and port tuple
- QUIC connections are defined by a 64-bit ID generated by the client
- Using a separate ID greatly simplifies the process of migrating connections from one network to another

5.3 Remote Procedure Call
=========================

Request/Reply
-------------

- A Simple paradigm for interacting with a server is to make a request and *block* while waiting for a reply.

---

![Simple RPC Example](https://book.systemsapproach.org/_images/f05-13-9780123850591.png)

RPC Challenges
--------------

- IP is unreliable
- Packets may be reordered
- Message may not fit in single packets

RPC Requirements
----------------

1. Reliable communication protocol
2. A mechanism to convert data and instructions to a shared format (stub compiler)

---

![Complete RPC Mechanism](https://book.systemsapproach.org/_images/f05-14-9780123850591.png){height=540px}

RPC Identifiers
---------------

- Provide a name space for uniquely identifying the procedure to be called
- Match each reply message to the corresponding request message

Overcoming Network Limitations
------------------------------

- Reliability (we can use TCP, but it may be more expensive)
- Support for large message

---

![Simple RPC ACK Model](https://book.systemsapproach.org/_images/f05-15-9780123850591.png)

---

Implicit ACK
------------

- In some cases we may be able to skip sending explicit ACKs
- We can use replys and requests as implicit ACKs

---

![RCP with implicit ACK](https://book.systemsapproach.org/_images/f05-16-9780123850591.png)

---

![gRPC Example](https://book.systemsapproach.org/_images/Slide13.png)

---

![gRPC Stack](https://book.systemsapproach.org/_images/Slide21.png)

5.4 Transport for Real-Time
===========================

Real-time
---------

- Traditional uses of network (email, file transfers, etc) don't have real-time requirements
- Some more modern uses (VoIP, videoconferencing, etc) do have these requirements

Application Types
-----------------

- Interactive - two or more people communicating directly (Google Meet)
- Streaming - data is being delivered and viewed immediately (Netflix)

UDP
---

- Adds no additional latency
- Does not provide reliability
- Does not handle reordering

TCP
---

- Reliable
- Handles reordering
- Adds latency in case of errors or reordering

RTP
---

- Real-time protocol
- Designed to handle communication between a variety of interactive applications

---

![Common RTP Stack](https://book.systemsapproach.org/_images/f05-22-9780123850591.png)

Requirements
------------

- Coding scheme advertisement and selection
- Timestamping for continuous playback from buffer
- Stream sync
- Packet loss indication
- Usernames
- Limited overhead

Ports
-----

- Data is sent over an even-numbered UDP port
- Control information is sent over a port one higher

Handshaking
-----------

- Video protocol
- Voice protocol

---

![RTP Header](https://book.systemsapproach.org/_images/f05-23-9780123850591.png)

Header Fields
-------------

- V - version
- P - padding
- x - counts contributing sources
- m - marker bit (application specific use)
- pt - payload type to demultiplex streams

Timestamps
----------

- Indicate start time of first sample in packet
- Does not represent actual time, only relative time
- Time unit is left up to application

Synchronization Source
----------------------

- SSRC
- 32-bit self-assigned address
- Creates separation from IP protocol
- Allows multiple streams (e.g. cameras) from 1 IP address

Contributing Sources
--------------------

- A mixer may combine multiple streams into a single stream
- The SSRC values for the contributing sources will be listed by a mixer in the CSRC fields

Congestion Control
------------------

- TCP is used for latency reasons
- We can't send data slower
- We can change parameters to send less data

Security
--------

- Unencrypted by default
- DTLS and SRTP can provide encryption

Control Protocol
----------------

- Feedback on the performance of the application and the network
- A way to correlate and synchronize different media streams that have come from the same sender
- A way to convey the identity of a sender for display on a user interface


Time Synchronization
-------------------

- RTCP packets include a mechanism to relate stream-specific timing information to clock time
