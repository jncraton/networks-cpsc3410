2.2 Encoding
============

---

How do we correctly communicate a stream of bits down a medium that we can turn on and off?

---

Network adapter
---------------

- Performs bitstream encoding
- We'll assume that *modulation* has been handled, and we have a medium that we can make either high or low

Examples
--------

- Light in a fiber cable (ASK)
- Voltage on a serial cable (high or low)
- ASK for a Wifi signal

![Bits flowing between adapters](https://book.systemsapproach.org/_images/f02-03-9780123850591.png)

---

Non-return to zero (NRZ) encoding
---------------------------------

- High maps to 1
- Low maps to 0

---

![NRZ Encoding](https://book.systemsapproach.org/_images/f02-04-9780123850591.png)

Problems with NRZ
-----------------

Long strings of 1s or 0s in data cause problems with

- Baseline wander
- Clock recovery

Baseline Wander
---------------

- Receiver stores a moving average of the signal level
- A steady state causes the average to move too high
- This can lead to value being misread

Clock
-----

- Determines when to read the medium to determine the current bit value

Clock Recovery
--------------

- Clocks at senders and receivers are not perfectly synced
- We resync clocks at state transitions
- Too few state transitions can lead to clocks drifting apart

---

Fireflies
---------

- Can flash at night
- Some species can synchronize their flashes

---

[Interactive Fireflies](https://ncase.me/fireflies/)

Non-return to zero inverted (NRZI)
----------------------------------

- State change represents a 1
- Steady state represents a 0
- Solves issue with repeated 1s
- Doesn't help with repeated 0s

Manchester Encoding
-------------------

- XOR an explicit clock signal with the data signal
- We always have state transitions
- Requires 2x data rate
- Used by Fast Ethernet

---

![Encoding schemes](https://book.systemsapproach.org/_images/f02-05-9780123850591.png)

4B/5B
-----

- Encode all 4 bit sequences as 5 bit sequences with state transitions
- e.g. 0000 becomes 11110
- Ensure state transition with less overhead than Manchester encoding
- USB uses variants of this (10b/12b, 128b/132b)

Baud rate vs bit rate
---------------------

- Baud rate - symbols per time
- Bit rate - bits per time
- These can be the same if we transmit 1 bit per symbol

2.3 Framing
===========

Frames
------

We now know how to exchange bitstreams between nodes on a network.

We need to develop algorithms and protocols to handle *frames* to build a packet-switched network over the bitstream.

---

![Bits between adapters become frames seen by hosts](https://book.systemsapproach.org/_images/f02-06-9780123850591.png)

---

We'll look specifically at point-to-point links, but the same basic techniques apply to broadcast links as well.

Byte-oriented protocols
=======================

---

View frames as collection of bytes rather than simple bits

Examples
--------

- BISYNC - IBM protocol from the 60s
- DDCMP - Used by DEC in DECNET
- PPP - Point-to-point protocol, a modern approach

Sentinel values
---------------

- Used to denote start and end of frames in some protocols
- Also known as flag bytes

BISYNC
------

- SYN - synchronization - indicates start of frame
- STX - start of text section
- ETX - end of text

---

Sentinel characters are just a byte. What if we need to send this byte in our data?

Byte stuffing
-------------

- Escape special characters when used in data
- Also escape the escapes

C Example
---------

```c
printf("Double quote: \"");
printf("Backslash: \\");
```

Length field
------------

Instead of using sentinel values, we can transmit a frame length and count bytes

---

What if a bit error causes the length or flag byte to be changed?

Framing Errors
--------------

- Bit error in length will cause adapter to read to much or too little data
- Bit error in flag will also cause frames to be misunderstood

Point-to-point protocol (PPP)
-----------------------------

- Common protocol used by many types of links
    - Fiber
    - Dial-up
    - Point-to-point radio
- Uses flag bytes and byte stuffing

---

What if errors occur in our data?

---

Include a checksum (we'll cover this more next time)

---

![PPP frame](https://book.systemsapproach.org/_images/f02-08-9780123850591.png)

Bit-oriented protocols
======================

---

Bit-oriented protocols are not concerned with byte boundaries

High-Level Data Link Control (HDLC)
-----------------------------------

- Developed by IBM
- Became ISO standard
- Bit-oriented protocol

---

![HDLC Frame](https://book.systemsapproach.org/_images/f02-10-9780123850591.png)

Bit flags
---------

- 0b01111110 denotes start and end of frame

Bit stuffing
------------

- Required when we want to send flag bit sequence in data
- Sender - 5 consecutive literal 1s (0b11111) will be encoded as 0b111110
- Receiver - When 0b111110 is seen, the 0 is dropped

Bit and byte stuffing
---------------------

- When these techniques are used, the length of the frame will be determined by contents of the data we are sending- e.g. 8 data bytes could be 8, 9, or 10+ bytes on the wire

Clock-based Framing
===================

---

Synchronous Optical Network (SONET)
-----------------------------------

- Common fiber protocol
- Frames will always be the same size, regardless of payload contents
- Does not use stuffing

---

How do we know when a frame begins?

---

- We still use a flag pattern to indicate the frame boundary
- We know it may appear in data, so we implement a clock to determine when it is expected
- The clock can be synced initially by listening to multiple frames

---

![STS-1 SONET Frame](https://book.systemsapproach.org/_images/f02-11-9780123850591.png)

Overhead bytes
--------------

- Not covering in detail in this class
- Allow additional features, such as multiplexing

Encoding
--------

- SONET uses NRZ
- How do we ensure there are enough transitions for clock recovery and DC balance?

Scrambling
----------

- Data is XOR'd with a 127 bit known pattern
- This process makes it unlikely that the data stream will include long runs of the same value

---

What if someone wants to break our network?

Scrambling DOS
--------------

- If the scrambling bit pattern is known and fixed, it is trivial to craft a payload that results in a long repeated sequence
- This will cause framing, clocking, and DC balance issues and practically disable a link

Solution
--------

- [RFC2615](https://tools.ietf.org/html/rfc2615#page-4)
- Introduce a self-synchronizing, rotating scrambling pattern that is difficult to guess

