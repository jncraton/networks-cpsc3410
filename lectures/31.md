QUIC
====

Saving Round Trips
------------------

- The layered nature of our stack can cause inefficiency
- TCP requires a handshake to establish a connection
- If we desire encryption, we need a second handshake to establish that

QUIC
----

- Combines establishing a connection and establishing encryption into one handshake
- Can save one RTT of latency when creating connections
- HTTP/3 uses QUIC for transport

---

![TLS vs QUIC handshake](media/quic-handshake.png)

---

Connection Identifiers in QUIC
------------------------------

- TCP connections are defined by their address and port tuple
- QUIC connections are defined by a 64-bit ID generated by the client
- Using a separate ID greatly simplifies the process of migrating connections from one network to another

5.3 Remote Procedure Call
=========================

Request/Reply
-------------

- A Simple paradigm for interacting with a server is to make a request and *block* while waiting for a reply.

---

![Simple RPC Example](https://book.systemsapproach.org/_images/f05-13-9780123850591.png)

RPC Challenges
--------------

- IP is unreliable
- Packets may be reordered
- Message may not fit in single packets

RPC Requirements
----------------

1. Reliable communication protocol
2. A mechanism to convert data and instructions to a shared format (stub compiler)

---

![Complete RPC Mechanism](https://book.systemsapproach.org/_images/f05-14-9780123850591.png){height=540px}

RPC Identifiers
---------------

- Provide a name space for uniquely identifying the procedure to be called
- Match each reply message to the corresponding request message

Overcoming Network Limitations
------------------------------

- Reliability (we can use TCP, but it may be more expensive)
- Support for large messages

---

![Simple RPC ACK Model](https://book.systemsapproach.org/_images/f05-15-9780123850591.png)

---

Implicit ACK
------------

- In some cases we may be able to skip sending explicit ACKs
- We can use replys and requests as implicit ACKs

---

![RCP with implicit ACK](https://book.systemsapproach.org/_images/f05-16-9780123850591.png)

---

![gRPC Example](https://book.systemsapproach.org/_images/Slide13.png)

---

![gRPC Stack](https://book.systemsapproach.org/_images/Slide21.png)

5.4 Transport for Real-Time
===========================

Real-time
---------

- Traditional uses of network (email, file transfers, etc) don't have real-time requirements
- Some more modern uses (VoIP, videoconferencing, etc) do have these requirements

Application Types
-----------------

- Interactive - two or more people communicating directly (Google Meet, VoIP)
- Streaming - data is being delivered and viewed immediately (Netflix, YouTube)

UDP
---

- Adds no additional latency
- Does not provide reliability
- Does not handle reordering

TCP
---


- Reliable
- Handles reordering
- Adds latency in case of errors or reordering
RTP
---

- Real-time protocol
- Designed to handle communication between a variety of interactive applications

---

![Common RTP Stack](https://book.systemsapproach.org/_images/f05-22-9780123850591.png)

Requirements
------------

- Coding scheme advertisement and selection
- Timestamping for continuous playback from buffer
- Stream sync
- Packet loss indication
- Usernames
- Limited overhead

Ports
-----

- Data is sent over an even-numbered UDP port
- Control information is sent over a port one higher

Handshaking
-----------

- Video protocol
- Voice protocol

---

![RTP Header](https://book.systemsapproach.org/_images/f05-23-9780123850591.png)

Header Fields
-------------

- V - version
- P - padding
- x - counts contributing sources
- m - marker bit (application specific use)
- pt - payload type to demultiplex streams

Timestamps
----------

- Indicate start time of first sample in packet
- Does not represent actual time, only relative time
- Time unit is left up to application

Synchronization Source
----------------------

- SSRC
- 32-bit self-assigned address
- Creates separation from IP protocol
- Allows multiple streams (e.g. cameras) from 1 IP address

Contributing Sources
--------------------

- A mixer may combine multiple streams into a single stream
- The SSRC values for the contributing sources will be listed by a mixer in the CSRC fields

Congestion Control
------------------

- TCP is not used for latency reasons
- We can't send data slower
- We can change parameters to send less data

Security
--------

- Unencrypted by default
- DTLS and SRTP can provide encryption

Control Protocol
----------------

- Feedback on the performance of the application and the network
- A way to correlate and synchronize different media streams that have come from the same sender
- A way to convey the identity of a sender for display on a user interface


Time Synchronization
-------------------

- RTCP packets include a mechanism to relate stream-specific timing information to clock time

6.1 Issues in Resource Allocation
=================================

Resource Allocation
-------------------

- Process by which network elements try to meet the competing demands that applications have for network resources
    - Link bandwidth
    - Router/switch buffer space

Congestion Control
------------------

- Efforts made by network nodes to prevent or respond to overload conditions
- Congestion is bad for everyone
- The goal should be to eliminate or even prevent it

Flow Control
------------

- Congestion control deals with the network as a whole
- Flow control deals with a pair of hosts not overwhelming one another

Packet-Switched Network
-----------------------

- Multiple links connected to deliver packets
- Hosts and routers do not have complete information about available bandwidth of the network

---

![Possible bottleneck](https://book.systemsapproach.org/_images/f06-01-9780123850591.png)

Connectionless Flows
--------------------

- IP packets are routed independently
- It is useful to consider packets between a pair of hosts following a similar route as a single *flow*

---

![Flows](https://book.systemsapproach.org/_images/f06-02-9780123850591.png)

Soft State
----------

- State that does not need to be explicitly created and destroyed via signaling
- Most routers maintain soft state about flows to aid in resource allocation

Characteristics
---------------

- Router-Centric versus Host-Centric
- Reservation-Based versus Feedback-Based
- Window Based versus Rate Based

Evaluation
----------

- Throughput should be maximized
- Delay should be minimized

Power
-----

- Throughput / Delay
- Ratio is a function of load placed on network by allocation mechanism
- Ratio should be maximized

---

![Ratio of throughput to delay as a function of load](https://book.systemsapproach.org/_images/f06-03-9780123850591.png)

Fairness
--------

- It isn't sufficient to optimize overall throughput and delay
- Applications and hosts competing for network resources must be given appropriate usage


6.2 Queuing Disciplines
=======================

Routers
-------

- Maintain queues of packets to be forwarded
- The design and use of these queues is a queuing discipline

FIFO
----

- First-in, first-out
- Packets are forwarded in the order they arrive

---

![FIFO Example](https://book.systemsapproach.org/_images/f06-05-9780123850591.png){height=540px}

Fairness
--------

- FIFO allocates packets based on arrival
- A host sending a lot of data will dominate the link
- Hosts sending little data will experience high latency

Fair Queuing
-------------

- Use buffers for each flow
- Send packets in FIFO order per flow in round-robin fashion

---

![Round-robin service](https://book.systemsapproach.org/_images/f06-06-9780123850591.png)

Packet Sizes
------------

- Packets may be different sizes
- We must account for this in order to ensure fairness
- This makes the simple round-robin example a bit more complicated

---

![Queuing in action](https://book.systemsapproach.org/_images/f06-07-9780123850591.png)

Properties
----------

1. *Work conserving* - The link will be active as long as there is a packet in the queue
2. Flows may use only 1/n of the link bandwidth when the link is full

Weighted Fair Queuing
---------------------

- We can assign weights to flows to give them more or less bandwidth
- Weights can be determined in various ways (hosts, traffic type, etc)
- Weights can ultimately be used to shape traffic and provide differing quality of service

6.3 TCP Congestion Control
==========================

Overview
--------

- CongestionWindow is managed by sender to limit packets in flight and transmission speed

Congestion Window
-----------------

- Set based on perceived network congestion
- Packet timeouts are used to adjust window size
- Additive Increase/Multiplicative Decrease

---

![Additive Increase](https://book.systemsapproach.org/_images/f06-08-9780123850591.png){height=540px}

---

Why use additive increase and multiplicative decrease?

Window Adjustment
-----------------

- Halve window size on each timeout
- Add 1 to window size on each successful round trip
- In practice, we increase window size for each ACK

---

![Sawtooth Congestion Window over time](https://book.systemsapproach.org/_images/f06-09-9780123850591.png)

Slow Start
----------

- TCP originally sent as many packets as the advertised window would allow when starting connections
- This caused congestion issues, and the behavior was changed to double the congestion window on each ACK at the start of a connection
- Slow start is also used when the connection is dead after waiting for a timeout

---

![TCP Slow Start](https://book.systemsapproach.org/_images/f06-10-9780123850591.png){height=540px}

Fast Retransmit
---------------

- Ordinarily, we wait for a coarse-grained timeout before sending a packet
- A receiver can safely send ACKs for all packets, using the sequence number of the last packet received in order
- By listening for duplicate ACKs, a sender can deduce lost packets and retransmit them

---

![Fast retransmit based on duplicate ACKs](https://book.systemsapproach.org/_images/f06-12-9780123850591.png){height=540px}

TCP CUBIC
---------

- Alternative congestion window management algorithm
- Default algorithm used by Linux

Max Window Size
---------------

- TCP CUBIC tracks the largest congestion window it was able to use successfully before experiencing congestion
- After a congestion event, CUBIC attempts to return to this window size at a cubic rate
- It approaches slowly, plateaus for, and then attempts to probe for a larger max window

---

![TCP CUBIC congestion window adjustment](https://book.systemsapproach.org/_images/Slide11.png)

6.5 Quality of Service
======================

QoS
---

- Applications have different needs
- A network that supports these different needs is said to support Quality of Service (QoS)

Requirements
------------

- Bandwidth
- Latency
- Jitter
- Packet loss

---

![Audio Example](https://book.systemsapproach.org/_images/f06-20-9780123850591.png)

Buffering
---------

- Audio is broken into time slices and sent as packets
- Packets are buffered and played back

---

![Playback Buffer](https://book.systemsapproach.org/_images/f06-21-9780123850591.png)

Buffer size
-----------

- A larger buffer will be more resistant to jitter and packet loss
- A larger buffer also induces delay

Application Needs
-----------------

- Real-time vs elastic
- Intolerant to packet loss
- Able to adapt to different level of bandwidth by adjusting rate
- Able to adapt to jitter and latency using larger buffers

---

![Application Characteristics](https://book.systemsapproach.org/_images/f06-23-9780123850591.png)

QoS Approaches
--------------

- Fine-grained - make adjustments by flow or application
- Course-grained - provides different levels of services to large classes of data

Service Classes
---------------

- Best-effort - default service
- Guaranteed service - ensures delivery under a maximum delay threshold
- Controlled load - operates like the network is lightly loaded up to a certain bandwidth constraint

Mechanism
---------

- Request service by sending a flowspec
- Admission control determines if service is available
- Packet scheduling works to meet flowspec requirements

Traffic Characteristics
-----------------------

- Maximum delay
- Bandwidth

Bandwidth
---------

- May vary over time (example: compressed video)
- An average and/or upper and lower bound can be useful
- A token bucket can be used to implement an average bandwidth
- Bucket rate communicates average and bucket depth handles bursts

---

![Flows with identical average bitrate but different bucket specs](https://book.systemsapproach.org/_images/f06-24-9780123850591.png)

Admission Control
-----------------

- Only allow new flows we are confident we can service
- Requires knowledge of routing algorithms and network state

Scheduling
----------

- When packets arrive related to a given service, ensure they are delivered meeting the needs of the service
- Can be implemented with something like weighted fair queuing or a similar algorithm

Scalability
-----------

- An integrated services model suffers from scalability issues
- This model has not been widely deployed on the Internet

Differentiated Services
-----------------------

- Skips complexity of requesting service
- Tags certain packets as "premium" to be delivered first
- Routers should forward these packets at a higher priority

---

Who gets to set the packet priority?

Setting priority
----------------

- If hosts can set high priority, they might all do that selfishly
- Bit may be set by border routers
- Can be used on local networks where hosts are trusted
- Can be used to prioritize particular packets from a given host
